<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulaire de contact</title>
    <meta name="solana-wallet" content="none">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
    <link href="./style.css" rel="stylesheet" />
</head>

<body>

    <form id="contactForm">
        <img src="../golden-dessert-logo.png">
        <h2>Contactez-nous</h2>
        <p style="text-align: center; color:white;">Et recevez le catalogue automatiquement.</p>

        <label for="email">Email</label>
        <input type="email" id="email" placeholder="Email" required />

        <label for="fullname">Nom complet</label>
        <input type="text" id="fullname" placeholder="Nom Prénom" required />

        <label for="statut">Vous êtes :</label>
        <select id="statut" required>
            <option value="">-- Choisissez une option --</option>
            <option value="restaurateur">Restaurateur</option>
            <option value="fournisseur">Fournisseur</option>
        </select>


        <label for="telephone">Téléphone</label>
        <input type="tel" id="telephone" placeholder="+33 6 12 34 56 78" />

        <label for="siteweb">Site Internet</label>
        <input type="url" id="siteweb" placeholder="https://votresite.com" />

        <label for="message">Message</label>
        <textarea id="message" rows="5" placeholder="Message" required></textarea>

        <button type="submit">Envoyer</button>
    </form>
    <!--<form action="https://formspree.io/f/mjkrbalj" method="POST" class="contact-form">
        <img src="../golden-dessert-logo.png">
        <h2>Contactez-nous</h2>
        <label for="email">Email</label>
        <input type="email" name="email" placeholder="Votre mail" required>
        <label for="message">Message</label>
        <textarea name="message" placeholder="Votre message." required></textarea>
        <button type="submit">Envoyer</button>
    </form>-->
    <br>
    <div class="return-link">
        <h2 style="margin-top:20px;font-size:1rem;"><a href="../index.html">← Revenir au site</a></h2>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2"

        // Configuration CORRECTE avec le schéma spécifié
        const supabase = createClient(
            "https://jcquyvoijndgbhqwccbx.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjcXV5dm9pam5kZ2JocXdjY2J4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg5NTgyODksImV4cCI6MjA2NDUzNDI4OX0.a4l3jwBt3AEdhpMT6qfzIA1SlmX29NiCWWto1DvysqI",
            {
                db: {
                    schema: 'public' // LA CLÉ DU PROBLÈME
                },
                auth: {
                    persistSession: false // Important pour les requêtes sans auth
                }
            }
        )

        // Version ULTRA-SÉCURISÉE du gestionnaire de formulaire
        document.getElementById("contactForm")?.addEventListener('submit', async (e) => {
            e.preventDefault()

            // 1. Validation des données
            const getValue = (id) => {
                const el = document.getElementById(id)
                return el ? el.value.trim() : null
            }

            const formData = {
                email: getValue("email"),
                fullname: getValue("fullname"),
                statut: getValue("statut"),
                telephone: getValue("telephone"),
                siteweb: getValue("siteweb"),
                message: getValue("message")
            }

            // 2. Vérification des champs obligatoires
            if (!formData.email || !formData.statut) {
                return Swal.fire("Erreur", "Email et statut sont obligatoires", "error")
            }

            try {
                // 3. Requête OPTIMISÉE
                const { error } = await supabase
                    .from('contacts')
                    .insert(formData) // Format simplifié

                if (error) throw error

                // 4. Redirection dynamique
                const redirectMap = {
                    restaurateur: "https://lien-restaurateur.com",
                    fournisseur: "https://lien-fournisseur.com"
                }
                window.location.href = redirectMap[formData.statut] || "/"

            } catch (error) {
                console.error("Erreur complète:", error)
                Swal.fire({
                    title: 'Erreur technique',
                    html: `<code>${error.code}: ${error.message}</code>`,
                    icon: 'error'
                })
            }
        })
    </script>

</body>

</html>